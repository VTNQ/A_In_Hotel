name: CI/CD for A_In_Hotel

on:
  push:
    branches: [ "deploy_web" ]

env:
  DOCKER_USERNAME: tranp6648
  DOCKER_PASSWORD: Anhthang61
  SERVER_HOST: 202.92.6.60
  SERVER_USER: tranp6648
  SERVER_PORT: 24700
  SERVER_SSH_KEY: |
    -----BEGIN OPENSSH PRIVATE KEY-----
    # (giá»¯ nguyÃªn ná»™i dung private key cá»§a báº¡n á»Ÿ Ä‘Ã¢y)
    -----END OPENSSH PRIVATE KEY-----

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout source
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ§± Build backend
        run: |
          cd be
          mvn clean package -DskipTests

      - name: âš›ï¸ Build frontend SuperAdmin
        run: |
          cd fe/SuperAdmin
          npm install
          npm run build

      - name: âš›ï¸ Build frontend User
        run: |
          cd fe/User
          npm install
          npm run build

  docker:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout source
        uses: actions/checkout@v4

      - name: ğŸ” Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: ğŸ³ Build & Push Backend
        run: |
          cd be
          docker build -t ${{ env.DOCKER_USERNAME }}/ainhotel-be:latest .
          docker push ${{ env.DOCKER_USERNAME }}/ainhotel-be:latest

      - name: ğŸ³ Build & Push Frontend SuperAdmin
        run: |
          cd fe/SuperAdmin
          docker build -t ${{ env.DOCKER_USERNAME }}/ainhotel-fe-superadmin:latest .
          docker push ${{ env.DOCKER_USERNAME }}/ainhotel-fe-superadmin:latest

      - name: ğŸ³ Build & Push Frontend User
        run: |
          cd fe/User
          docker build -t ${{ env.DOCKER_USERNAME }}/ainhotel-fe-user:latest .
          docker push ${{ env.DOCKER_USERNAME }}/ainhotel-fe-user:latest

  deploy:
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/deploy_web'
    steps:
      - name: ğŸš€ Deploy to VPS
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SERVER_SSH_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            echo "=== ğŸ§¹ Cleaning old containers ==="
            cd /home/${{ env.SERVER_USER }}/Desktop/A_In_Hotel

            echo "=== ğŸ“¦ Pulling latest Docker images ==="
            docker pull ${{ env.DOCKER_USERNAME }}/ainhotel-be:latest
            docker pull ${{ env.DOCKER_USERNAME }}/ainhotel-fe-superadmin:latest
            docker pull ${{ env.DOCKER_USERNAME }}/ainhotel-fe-user:latest

            echo "=== ğŸ§± Rebuilding docker-compose ==="
            docker-compose down
            docker-compose up -d --build

            echo "=== âœ… Deployment finished successfully ==="
